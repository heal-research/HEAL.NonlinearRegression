
using NUnit.Framework;
using System.Globalization;

namespace HEAL.NonlinearRegression.Console.Tests {
  public class NLR_EndToEnd {
    [SetUp]
    public void Setup() {
      CultureInfo.DefaultThreadCurrentCulture = CultureInfo.InvariantCulture;
      CultureInfo.DefaultThreadCurrentUICulture = CultureInfo.InvariantCulture;
      Thread.CurrentThread.CurrentCulture = CultureInfo.InvariantCulture;
      Thread.CurrentThread.CurrentUICulture = CultureInfo.InvariantCulture;
    }

    #region nonlinear Puromycin
    [Test]
    public void FitPuromycin() {
      var expected = @"p_opt: 6.41213e-002 2.12684e+002
Successful: True, NumIters: 3, NumFuncEvals: 44, NumJacEvals: 0
SSR: 1.1954e+003 s: 1.0934e+001 AICc: 1204.4 BIC: 1202.9 MDL: 614.2
Para       Estimate      Std. error     z Score          Lower          Upper Correlation matrix
    0    6.4121e-002    8.2809e-003   7.74e+000    4.5670e-002    8.2572e-002 1.00
    1    2.1268e+002    6.9472e+000   3.06e+001    1.9720e+002    2.2816e+002 0.77 1.00

Optimized: ((x0 / (0.06412128166090875 + x0)) * 212.68374312341493)
";
      NlrFit("Puromycin.csv", "x0 / (0.06412128165180965 + x0) * 212.68374312341493", "0:11", "y", "Gaussian", expected);
    }

    [Test]
    public void PredictPuromycinLaplace() {
      var expected = @"x0,y,residual,yPred,yPredLow,yPredHigh,isTrain,isTest
0.02,76,25.434022182225043,50.56597781777496,41.957912908934745,59.17404272661517,1,0
0.02,47,-3.5659778177749573,50.56597781777496,41.957912908934745,59.17404272661517,1,0
0.06,97,-5.810931507033644,102.81093150703364,92.10677233386393,113.51509068020336,1,0
0.06,107,4.189068492966356,102.81093150703364,92.10677233386393,113.51509068020336,1,0
0.11,123,-11.361587052503495,134.3615870525035,125.1259054263397,143.5972686786673,1,0
0.11,139,4.638412947496505,134.3615870525035,125.1259054263397,143.5972686786673,1,0
0.22,159,-5.6846839970068,164.6846839970068,156.8174930318183,172.5518749621953,1,0
0.22,152,-12.6846839970068,164.6846839970068,156.8174930318183,172.5518749621953,1,0
0.56,191,0.16706472152927176,190.83293527847073,180.5942013515739,201.07166920536756,1,0
0.56,201,10.167064721529272,190.83293527847073,180.5942013515739,201.07166920536756,1,1
1.1,207,6.031148110302098,200.9688518896979,188.60791098183105,213.32979279756475,1,1
1.1,200,-0.9688518896979019,200.9688518896979,188.60791098183105,213.32979279756475,1,1
";
      NlrPredict("Puromycin.csv", "x0 / (0.06412128165180965 + x0) * 212.68374312341493", "0:11", "0:11", "y", "Gaussian", "LaplaceApproximation", expected);
    }

    [Test]
    public void PredictPuromycinProfile() {
      var expected = @"x0,y,residual,yPred,yPredLow,yPredHigh,isTrain,isTest
0.02,76,25.434022182225043,50.56597781777496,42.25914848663243,60.36645187039165,1,0
0.02,47,-3.5659778177749573,50.56597781777496,42.25914848663243,60.36645187039165,1,0
0.06,97,-5.810931507033644,102.81093150703364,91.75750014059363,113.972535455165,1,0
0.06,107,4.189068492966356,102.81093150703364,91.75750014059363,113.972535455165,1,0
0.11,123,-11.361587052503495,134.3615870525035,124.6281849134739,143.6212425653815,1,0
0.11,139,4.638412947496505,134.3615870525035,124.6281849134739,143.6212425653815,1,0
0.22,159,-5.6846839970068,164.6846839970068,156.77624310389666,172.54972638895697,1,0
0.22,152,-12.6846839970068,164.6846839970068,156.77624310389666,172.54972638895697,1,0
0.56,191,0.16706472152927176,190.83293527847073,180.4690523155308,201.19666313895664,1,0
0.56,201,10.167064721529272,190.83293527847073,180.4690523155308,201.19666313895664,1,1
1.1,207,6.031148110302098,200.9688518896979,188.5081808414774,213.7744797416022,1,1
1.1,200,-0.9688518896979019,200.9688518896979,188.5081808414774,213.7744797416022,1,1
";
      NlrPredict("Puromycin.csv", "x0 / (0.06412128165180965 + x0) * 212.68374312341493", "0:11", "0:11", "y", "Gaussian", "TProfile", expected);
    }
    #endregion

    #region linear Puromycin (to compare LaplaceApproximation = tProfile for linear Gaussian models)
    [Test]
    public void FitLinearPuromycin() {
      var expected = @"p_opt: 1.10421e+002 1.03488e+002
Successful: True, NumIters: 2, NumFuncEvals: 10, NumJacEvals: 0
SSR: 9.5471e+003 s: 3.0898e+001 AICc: 9556.1 BIC: 9554.6 MDL: 4783.7
Para       Estimate      Std. error     z Score          Lower          Upper Correlation matrix
    0    1.1042e+002    2.3371e+001   4.72e+000    5.8347e+001    1.6249e+002 1.00
    1    1.0349e+002    1.2024e+001   8.61e+000    7.6697e+001    1.3028e+002 -0.67 1.00

Optimized: ((110.42107672063618 * x0) + 103.48806186471386)
";
      NlrFit("Puromycin.csv", "((110.42107672063611 * x0) + 103.48806186471387)", "0:11", "y", "Gaussian", expected);
    }

    [Test]
    public void PredictLinearPuromycinLaplace() {
      // exactly the same as for t-Profile!
      var expected = @"x0,y,residual,yPred,yPredLow,yPredHigh,isTrain,isTest
0.02,76,-29.696483399126592,105.69648339912659,79.5928197722846,131.80014702596858,1,0
0.02,47,-58.69648339912659,105.69648339912659,79.5928197722846,131.80014702596858,1,0
0.06,97,-13.113326467952035,110.11332646795204,85.30937235031085,134.9172805855932,1,0
0.06,107,-3.113326467952035,110.11332646795204,85.30937235031085,134.9172805855932,1,0
0.11,123,7.365619696016154,115.63438030398385,92.29487883245449,138.9738817755132,1,0
0.11,139,23.365619696016154,115.63438030398385,92.29487883245449,138.9738817755132,1,0
0.22,159,31.219301256746178,127.78069874325382,106.86779360020267,148.69360388630497,1,0
0.22,152,24.219301256746178,127.78069874325382,106.86779360020267,148.69360388630497,1,0
0.56,191,25.676135171729868,165.32386482827013,142.5131839174026,188.13454573913765,1,0
0.56,201,35.67613517172987,165.32386482827013,142.5131839174026,188.13454573913765,1,1
1.1,207,-17.95124625741363,224.95124625741363,180.89778117957925,269.00471133524803,1,1
1.1,200,-24.95124625741363,224.95124625741363,180.89778117957925,269.00471133524803,1,1
";
      NlrPredict("Puromycin.csv", "((110.42107672063611 * x0) + 103.48806186471387)", "0:11", "0:11", "y", "Gaussian", "LaplaceApproximation", expected);
    }

    [Test]
    public void PredictLinearPuromycinProfile() {
      // exactly the same as for LaplaceApproximation!
      var expected = @"x0,y,residual,yPred,yPredLow,yPredHigh,isTrain,isTest
0.02,76,-29.696483399126592,105.69648339912659,79.59281977228459,131.80014702596858,1,0
0.02,47,-58.69648339912659,105.69648339912659,79.59281977228459,131.80014702596858,1,0
0.06,97,-13.113326467952035,110.11332646795204,85.30937235031082,134.91728058559318,1,0
0.06,107,-3.113326467952035,110.11332646795204,85.30937235031082,134.91728058559318,1,0
0.11,123,7.365619696016154,115.63438030398385,92.29487883245447,138.97388177551318,1,0
0.11,139,23.365619696016154,115.63438030398385,92.29487883245447,138.97388177551318,1,0
0.22,159,31.219301256746178,127.78069874325382,106.86779360020265,148.69360388630497,1,0
0.22,152,24.219301256746178,127.78069874325382,106.86779360020265,148.69360388630497,1,0
0.56,191,25.676135171729868,165.32386482827013,142.51318391740259,188.13454573913765,1,0
0.56,201,35.67613517172987,165.32386482827013,142.51318391740259,188.13454573913765,1,1
1.1,207,-17.95124625741363,224.95124625741363,180.89778117957925,269.00471133524803,1,1
1.1,200,-24.95124625741363,224.95124625741363,180.89778117957925,269.00471133524803,1,1
";
      NlrPredict("Puromycin.csv", "((110.42107672063611 * x0) + 103.48806186471387)", "0:11", "0:11", "y", "Gaussian", "TProfile", expected);
    }
    #endregion


    #region logistic regression mammography
    [Test]
    public void FitMammography() {
      // verified against R logistic regression (same fitting results)
      var expected = @"p_opt: 1.38378e+000 4.84833e-002 5.24299e-001 3.52511e-001 -6.84851e-002 -1.11809e+001
Successful: True, NumIters: 195, NumFuncEvals: 614, NumJacEvals: 0
SSR: 1.1948e+002 s: 3.5371e-001 AICc: 798.5 BIC: 832.5 MDL: 457.0
Para       Estimate      Std. error     z Score          Lower          Upper Correlation matrix
    0    1.3838e+000    3.6391e-002   3.80e+001    1.3124e+000    1.4552e+000 1.00
    1    4.8483e-002    2.8530e-003   1.70e+001    4.2884e-002    5.4082e-002 0.11 1.00
    2    5.2430e-001    3.7910e-002   1.38e+001    4.4990e-001    5.9870e-001 0.05 0.01 1.00
    3    3.5251e-001    3.0434e-002   1.16e+001    2.9279e-001    4.1224e-001 -0.10 -0.07 -0.67 1.00
    4   -6.8485e-002    8.2664e-002  -8.28e-001   -2.3071e-001    9.3739e-002 -0.01 -0.03 -0.08 -0.03 1.00
    5   -1.1181e+001    3.3318e-001  -3.36e+001   -1.1835e+001   -1.0527e+001 -0.49 -0.50 -0.12 0.04 -0.67 1.00

Optimized: Logistic(((((((1.383783475779263 * BI_RADS) + (0.04848326870704811 * Age)) + (0.5242993934294974 * Shape)) + (0.35251072256819216 * Margin)) + (-0.06848513367625006 * Density)) + -11.180915607397608))
";
      NlrFit("mammography.csv",
        "Logistic(((((((2.2567076159618358 * BI_RADS) + (0.04380746945531807 * Age)) + (0.5000365292519695 * Shape)) + (0.3044656335194289 * Margin)) + (-0.024110900815627095 * Density)) + -14.579127936956462))", 
        "0:960", 
        "Severity",
        "Bernoulli",
        expected);
    }

    [Test]
    public void PredictMammographyLaplace() {
      var expected = @"BI_RADS,Age,Shape,Margin,Density,y,residual,yPred,yPredLow,yPredHigh,isTrain,isTest
5,67,3,5,3,1,0.10751521187441859,0.8924847881255814,0.8785780358538436,0.9063915403973192,1,0
4,43,1,1,3,1,0.9473322449203974,0.05266775507960262,0.04521183752913817,0.06012367263006707,1,0
5,58,4,5,3,1,0.09936258583801727,0.9006374141619827,0.8901521941241752,0.9111226341997902,1,0
4,28,1,1,3,0,-0.02616305750483777,0.02616305750483777,0.020931999013771036,0.0313941159959045,1,0
5,74,1,5,3,1,0.19668219371154416,0.8033178062884558,0.761877187595353,0.8447584249815587,1,0
4,65,1,3,3,0,-0.24638372913929282,0.24638372913929282,0.2165561874664948,0.27621127081209085,1,0
4,70,3,3,3,0,-0.5431479146698254,0.5431479146698254,0.519536777837749,0.5667590515019018,1,0
5,42,1,3,3,0,-0.299574513189939,0.299574513189939,0.26135467458910355,0.33779435179077444,1,0
5,57,1,5,3,1,0.35825508046733845,0.6417449195326616,0.5849088388084933,0.6985810002568298,1,0
5,60,3,5,1,1,0.12853611407770482,0.8714638859222952,0.8325946698103599,0.9103331020342305,1,0
5,76,1,4,3,1,0.24019385030590246,0.7598061496940975,0.7186297649960185,0.8009825343921766,1,0
3,42,2,1,3,1,0.9780676003581101,0.02193239964188982,0.018421397500124073,0.02544340178365557,1,0
4,64,1,3,3,0,-0.23749248435765508,0.23749248435765508,0.20862699489045264,0.2663579738248575,1,0
4,36,3,1,2,0,-0.10794120010644159,0.10794120010644159,0.08562515775540677,0.1302572424574764,1,0
4,60,2,1,2,0,-0.18654071132515063,0.18654071132515063,0.15878421588851052,0.21429720676179073,1,0
4,54,1,1,3,0,-0.08656390328372499,0.08656390328372499,0.07632729410473452,0.09680051246271545,1,0
3,52,3,4,3,0,-0.1504661598736393,0.1504661598736393,0.13392922167971372,0.16700309806756486,1,0
4,59,2,1,3,1,0.8305618978661792,0.1694381021338208,0.15329711329039827,0.18557909097724332,1,0
4,54,1,1,3,1,0.913436096716275,0.08656390328372499,0.07632729410473452,0.09680051246271545,1,0
4,40,1,3,3,0,-0.08866261736270638,0.08866261736270638,0.07361557437202361,0.10370966035338915,1,0
";
      NlrPredict("mammography.csv",
        "Logistic(((((((1.383783475779263 * BI_RADS) + (0.04848326870704811 * Age)) + (0.5242993934294974 * Shape)) + (0.35251072256819216 * Margin)) + (-0.06848513367625006 * Density)) + -11.180915607397608))",
        "0:960", "0:19", "Severity", "Bernoulli", "LaplaceApproximation", expected);
    }
    [Test]
    public void PredictMammographyProfile() {
      // verified against R with logistic regression
      // mammo_predictions = predict(fit_glm, mammography[1:10,], se.fit = TRUE) # type = "link" as default
      // z_crit = qnorm(0.975)
      // mammo_pred_low = mammo_predictions$fit-1 * z_crit * mammo_predictions$se.fit
      // mammo_pred_high = mammo_predictions$fit + 1 * z_crit * mammo_predictions$se.fit
      // 
      // data.frame(prob=predict(fit_glm, mammography[1:10,], se.fit = FALSE, type = "response"), 
      //           low=boot::inv.logit(mammo_pred_low), 
      //           high=boot::inv.logit(mammp_pred_high))
      //    prob        low       high
      //  1  0.89248381 0.84784386 0.92518287
      //  2  0.05266805 0.03536213 0.07776061
      //  3  0.90063675 0.86560368 0.92730468
      //  4  0.02616331 0.01520743 0.04465424
      //  5  0.80331579 0.67352705 0.88993877
      //  6  0.24638378 0.17586304 0.33373184
      //  7  0.54314781 0.47005149 0.61443203
      //  8  0.29957358 0.20112801 0.42082212
      //  9  0.64174304 0.48339643 0.77422326
      //  10 0.87146628 0.71141575 0.94910244
      var expected = @"BI_RADS,Age,Shape,Margin,Density,y,residual,yPred,yPredLow,yPredHigh,isTrain,isTest
5,67,3,5,3,1,0.10751521187441859,0.8924847881255814,0.8489371199143764,0.9259246294718708,1,0
4,43,1,1,3,1,0.9473322449203974,0.05266775507960262,0.03480233412230494,0.07673885805281129,1,0
5,58,4,5,3,1,0.09936258583801727,0.9006374141619827,0.8665102304386334,0.9279421646897174,1,0
4,28,1,1,3,0,-0.02616305750483777,0.02616305750483777,0.014887193483277255,0.04385479332359094,1,0
5,74,1,5,3,1,0.19668219371154416,0.8033178062884558,0.6753125671282608,0.8911635949255622,1,0
4,65,1,3,3,0,-0.24638372913929282,0.24638372913929282,0.17523693840552226,0.33331170808856847,1,0
4,70,3,3,3,0,-0.5431479146698254,0.5431479146698254,0.470007842319327,0.6147097480379803,1,0
5,42,1,3,3,0,-0.299574513189939,0.299574513189939,0.20060492457280082,0.4208162311728667,1,0
5,57,1,5,3,1,0.35825508046733845,0.6417449195326616,0.4841932033605182,0.7755572896063346,1,0
5,60,3,5,1,1,0.12853611407770482,0.8714638859222952,0.7112068107343287,0.9493778435665696,1,0
5,76,1,4,3,1,0.24019385030590246,0.7598061496940975,0.6356819455136818,0.8539336659659924,1,0
3,42,2,1,3,1,0.9780676003581101,0.02193239964188982,0.012755389589779148,0.036259435142172045,1,0
4,64,1,3,3,0,-0.23749248435765508,0.23749248435765508,0.168852056610219,0.32174047714845355,1,0
4,36,3,1,2,0,-0.10794120010644159,0.10794120010644159,0.06040771565052977,0.1814154851445408,1,0
4,60,2,1,2,0,-0.18654071132515063,0.18654071132515063,0.11898340402138355,0.27509284726769617,1,0
4,54,1,1,3,0,-0.08656390328372499,0.08656390328372499,NaN,0.11981019025100262,1,0
3,52,3,4,3,0,-0.1504661598736393,0.1504661598736393,NaN,0.22868722603126707,1,0
4,59,2,1,3,1,0.8305618978661792,0.1694381021338208,0.12646154855564998,0.22029042459183462,1,0
4,54,1,1,3,1,0.913436096716275,0.08656390328372499,NaN,0.11981019025100262,1,0
4,40,1,3,3,0,-0.08866261736270638,0.08866261736270638,0.05597707388937116,0.1351316533290748,1,0
";
      NlrPredict("mammography.csv",
        "Logistic(((((((1.383783475779263 * BI_RADS) + (0.04848326870704811 * Age)) + (0.5242993934294974 * Shape)) + (0.35251072256819216 * Margin)) + (-0.06848513367625006 * Density)) + -11.180915607397608))",
        "0:960", "0:19", "Severity", "Bernoulli", "TProfile", expected);
    }
    #endregion

    internal void NlrFit(string dataFilename, string model, string trainRange, string target, string likelihood, string expected) {
      RunConsoleTest(() => Program.Main(new[] { "fit", "--dataset", dataFilename, "--model", model, "--train", trainRange, "--target", target, "--likelihood", likelihood}), expected);
    }
    internal void NlrPredict(string dataFilename, string model, string trainRange, string predRange, string target, string likelihood, string intervalType, string expected) {
      RunConsoleTest(() => Program.Main(new[] { "predict", "--dataset", dataFilename, "--model", model, "--target", target, "--likelihood", likelihood, "--train", trainRange, "--range", predRange, "--interval", intervalType }), expected);
    }

    internal void RunConsoleTest(Action action, string expected) {
      var randFilename = Path.GetRandomFileName();
      try {
        using (var memWriter = new StreamWriter(randFilename)) {
          var origOut = System.Console.Out;
          System.Console.SetOut(memWriter);
          try {
            action();
          } finally {
            System.Console.SetOut(origOut);
          }
        }
        var actual = File.ReadAllText(randFilename);
        System.Console.WriteLine(actual);
        Assert.AreEqual(expected, actual);
      } finally {
        if (File.Exists(randFilename))
          File.Delete(randFilename);
      }
    }
  }
}
